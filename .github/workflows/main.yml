name: ğŸš€ Deploy website on push

on:
  push:
    branches:
      - deploy

jobs:
  web-deploy:
    name: ğŸ‰ Deploy
    runs-on: ubuntu-latest

    steps:
    - name: ğŸšš Get latest code
      uses: actions/checkout@v3

    - name: ğŸ“‚ Sync files
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ftp.opportunitiessharing.com
        username: ${{ secrets.ftp_username }}
        password: ${{ secrets.ftp_password }}
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/vendor/**
          **/public/vendor/**
          **/public/installer/**
          **/public/uploads/**
          **/storage/framework/**
          **/storage/app/public/**
          **/storage/logs/**
          **/public/images/**
          **/resources/lang/**
          **/app/Events/**
          **/app/Listeners/**
          **/app/Mail/**
          **/app/Models/**
          **/app/Notifications/**
          **/app/Policies/**
          **/app/Traits/**
          **/app/Http/**
          **/app/Providers/**
          **/app/Console/**
          **/app/Exceptions/**
          **/app/Repositories/**
          **/public/js/**
          **/resources/**
          **/tests/**
          **/database/**

    - name: ğŸ”§ Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2' # Specify the PHP version you're using

    - name: ğŸ“¦ Install dependencies
      run: composer install --no-interaction --prefer-dist --optimize-autoloader
      env:
        COMPOSER_PROCESS_TIMEOUT: 0
        COMPOSER_NO_INTERACTION: 1
        COMPOSER_NO_AUDIT: 1

    - name: ğŸ› ï¸ Install sshpass
      run: sudo apt-get install -y sshpass

    - name: ğŸš€ Run migrations
      shell: /usr/bin/bash -e {0}
      env:
        FTP_USERNAME: ${{ secrets.ftp_username }}
        FTP_PASSWORD: ${{ secrets.ftp_password }}
      run: |
        sshpass -p $FTP_PASSWORD ssh -o StrictHostKeyChecking=no $FTP_USERNAME@ftp.opportunitiessharing.com 'cd /home/your-cpanel-username/public_html && php artisan migrate'
